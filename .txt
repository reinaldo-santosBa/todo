import * as SQLite from 'expo-sqlite';
interface task {
    id: string;
    taskDesc: string;
    checked: boolean;
}

const db = SQLite.openDatabase('bd.db');

const initdatabase = (): Promise<void> => {
    return new Promise((resolve, reject) => {
        db.transaction((tx) => {
            tx.executeSql(
                `CREATE TABLE IF NOT EXISTS TASKS 
                    (
                        ID BLOB PRIMARY KEY,
                        DESC TEXT, 
                        CHECKED BOOLEAN DEFAULT 0
                    )
        `,
                [],
                () => {
                    console.log('Tabela criada com sucesso');
                    resolve();
                },
                (error) => {
                    console.error('Erro ao criar a tabela:', error);
                    reject(error);
                    return true;
                }
            );
        });
    });
};

const insert = ({ taskDesc, id }: task): Promise<void> => {
    return new Promise<void>((resolve, reject) => {
        db.transaction((tx) => {
            tx.executeSql(
                'INSERT INTO TASKS (ID,DESC) VALUES (?,?)',
                [id, taskDesc],
                (_, result) => {
                    console.log('Tarefa inserida com sucesso', result);
                    resolve();
                },
                (error) => {
                    console.error('Erro ao inserir tasks:', error);
                    reject(error);
                    return true;
                }
            );

        });
    });
};

const remove = ({ id }: task): Promise<void> => {
    return new Promise<void>((resolve, reject) => {
        db.transaction((tx) => {
            tx.executeSql(
                `
                    DELETE FROM
                        TASKS
                    WHERE
                        ID ?
                `,
                [id],
                (_, result) => {
                    console.log('Tarefa removida com sucesso', result);
                    resolve();
                },
                (error) => {
                    console.error('Erro ao remover tasks:', error);
                    reject(error);
                    return true;
                }
            );

        });
    });
};

const update = (id: string): Promise<void> => {
    return new Promise((resolve, reject) => {
        db.transaction((tx) => {
            tx.executeSql(
                `
                UPDATE
                    TASKS
                SET 
                    CHECKED = 1
                WHERE 
                    ID = ?
            `,
                [id],
                (_, result) => {
                    console.log('Update feito com sucesso', result);
                    resolve();

                },
                (error) => {
                    console.error('Erro ao fazer update de tasks id :' + id, error);
                    reject(error);
                    return true;
                }
            );
        });
    });
};


const select = () => {
    return new Promise<{
        id: number;
        desc: string;
        checked: boolean;
    }[]>(
        (resolve, reject) => {
            db.transaction((tx) => {
                tx.executeSql(
                    'SELECT * FROM TASKS',
                    [],
                    (_, result) => {
                        resolve(result.rows['_array']);
                    },
                    (error) => {
                        console.error('Erro ao selecionar as tasks:', error);
                        reject(error);
                        return true;
                    }
                );
            });
        }
    );
};

export {
    initdatabase,
    insert,
    remove,
    update,
    select
}